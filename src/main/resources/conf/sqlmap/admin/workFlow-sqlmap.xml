<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.v4java.workflow.dao.admin.WorkFlowDao" >

  <resultMap id="workFlow-resultMap" type="workFlow" >
    <id 	column="ID" 			property="id" 			jdbcType="INTEGER" />
    <result column="BUSY_TYPE_ID" 	property="busyTypeId" 	jdbcType="INTEGER" />
    <result column="MODEL_ID" 		property="modelId" 		jdbcType="INTEGER" />
    <result column="NAME" 			property="name" 		jdbcType="VARCHAR" />
    <result column="DESCRIPTION" 	property="description" 	jdbcType="VARCHAR" />
    
    <result column="JOBS_ID" 		property="jobsId" 		jdbcType="INTEGER" />
    <result column="WORKFLOW_NODE" 	property="workflowNode" jdbcType="INTEGER" />
    <result column="STATUS" 		property="status" 		jdbcType="INTEGER" />
    <result column="CREATE_TIME" 	property="createTime" 	jdbcType="TIMESTAMP" />
    <result column="UPDATE_TIME" 	property="updateTime" 	jdbcType="TIMESTAMP" />
    
    <result column="BUSY_TYPE_NAME" property="busyTypeName" jdbcType="VARCHAR" />
    <result column="MONEY" 			property="money" 		jdbcType="DECIMAL" />
    <result column="JSON" 			property="json" 		jdbcType="VARCHAR" />
    <result column="USER_NAME" 		property="userName" 	jdbcType="VARCHAR" />
  	<result column="USER_CODE" 		property="userCode" 	jdbcType="VARCHAR" />
    <result column="SYSTEM_ID"      property="systemId"    javaType="INTEGER"/>
  </resultMap>
  
  
  <resultMap type="workFlowVO" id="workFlowVO-resultMap">
  	<id 	column="ID" 					property="id" 				jdbcType="INTEGER" />
    <result column="BUSY_TYPE_ID" 			property="busyTypeId" 		jdbcType="INTEGER" />
    <result column="MODEL_ID" 				property="modelId" 			jdbcType="INTEGER" />
    <result column="NAME" 					property="name" 			jdbcType="VARCHAR" />
    <result column="DESCRIPTION" 			property="description" 		jdbcType="VARCHAR" />
    	
    <result column="CREATE_TIME" 			property="createTime" 		jdbcType="TIMESTAMP" />
    <result column="UPDATE_TIME" 			property="updateTime" 		jdbcType="TIMESTAMP" />
    <result column="JOBS_NAME" 				property="jobsName" 		jdbcType="VARCHAR" />
    <result column="JOBS_DESCRIPTION" 		property="jobsDescription" 	jdbcType="VARCHAR" />
    <result column="BUSY_TYPE_NAME" 		property="busyTypeName"	 	jdbcType="VARCHAR" />
    
    <result column="MONEY" 					property="money" 			jdbcType="DECIMAL" />
    <result column="JSON" 					property="json" 			jdbcType="VARCHAR" />
    <result column="USER_NAME" 				property="userName" 		jdbcType="VARCHAR" />
  	<result column="USER_CODE" 				property="userCode" 		jdbcType="VARCHAR" />
  	<result column="SYSTEM_ID"      		property="systemId"    		javaType="INTEGER"/>
  </resultMap>
  
  	<select id="findUserWorkFlowVOByUserCode" parameterType="string" resultMap="workFlowVO-resultMap">
  		SELECT 
  				WF.`ID`,WF.`BUSY_TYPE_ID`,WF.`NAME`,WF.`MODEL_ID`,WF.`DESCRIPTION` ,
  				WF.`CREATE_TIME` ,WF.`UPDATE_TIME`,WF.`MONEY`,WF.`BUSY_TYPE_NAME`,WF.`JSON`
  		FROM 
  				workflow  WF 
  		LEFT JOIN 
  				 jobs_user JU  ON WF.`jobs_id` = JU.`jobs_id`
  		LEFT JOIN 
  				jobs J ON J.`id` = JU.`jobs_id`
  				
  		WHERE 
  				JU.`USER_CODE` = #{userCode}	
  	</select>
  	
  	<select id="findUserWorkFlowVOCountByUserCode" parameterType="string" resultType="int">
  		SELECT 
  				COUNT(J.ID)
  		FROM 
  				workflow  WF 
  		LEFT JOIN 
  				 jobs_user JU  on WF.`JOBS_ID` = JU.`JOBS_ID`
  		LEFT JOIN 
  				jobs j on j.`ID` = JU.`JOBS_ID`
  				
  		WHERE 
  				JU.`USER_CODE` = #{userCode}	
  	</select>
  	
  	
	<insert id="insertWorkFlow" parameterType="workFlow">
		INSERT INTO workflow(
				BUSY_TYPE_ID ,MODEL_ID ,NAME ,DESCRIPTION ,JOBS_ID
				,WORKFLOW_NODE ,STATUS,MONEY,BUSY_TYPE_NAME,JSON,
				CREATE_TIME
			)
		VALUES(
			#{busyTypeId},#{modelId},#{name},#{description},#{jobsId},
			#{workflowNode},#{status},#{money},#{busyTypeName},
			now()
			)
	
	</insert>
	
	<update id="updateWorkFlow" parameterType="workFlow" >
		UPDATE workflow	 
		<set>
			<if test="name != null">
       			 NAME = #{name,jdbcType=VARCHAR},
      		</if>
			<if test="description != null">
       			 DESCRIPTION = #{description,jdbcType=VARCHAR},
      		</if>		
			<if test="jobsId != null">
       			 JOBS_ID = #{jobsId,jdbcType=INTEGER},
      		</if>
			<if test="workflowNode != null">
       			 WORKFLOW_NODE = #{workflowNode,jdbcType=INTEGER},
      		</if>      		
 			<if test="status != null">
       			 STATUS = #{status,jdbcType=INTEGER},
      		</if> 
			<if test="json != null">
       			 JSON = #{json,jdbcType=VARCHAR},
      		</if> 
      			UPDATE_TIME  = now()		    		
      </set>			
		WHERE id = #{id}	
	</update>
	
	
	<select id="findWorkFlowById" parameterType="java.lang.Integer" resultMap="workFlow-resultMap">
		SELECT 
				ID ,BUSY_TYPE_ID ,MODEL_ID ,NAME ,DESCRIPTION ,
				JOBS_ID ,WORKFLOW_NODE ,STATUS,MONEY,BUSY_TYPE_NAME,JSON
		FROM 
				workflow 
		WHERE
				ID = #{id}
	</select>
  
  
</mapper>